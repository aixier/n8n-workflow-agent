#!/usr/bin/env python3
"""
ç¤ºä¾‹: åˆ›å»ºYouTubeè§†é¢‘å¤„ç†å·¥ä½œæµ
æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨n8n Workflow Agentåˆ›å»ºå¤æ‚çš„å·¥ä½œæµ
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from tools.node_builder import NodeBuilder
from tools.n8n_workflow_manager import N8nWorkflowManager
import json


def create_youtube2post_workflow():
    """åˆ›å»ºYouTubeè½¬æ–‡ç« å·¥ä½œæµ"""

    print("ğŸš€ Creating YouTube2Post Workflow...")

    # åˆå§‹åŒ–èŠ‚ç‚¹æ„å»ºå™¨
    builder = NodeBuilder()

    # 1. åˆ›å»ºWebhookè§¦å‘å™¨
    webhook = builder.create_node('webhook', {
        'name': 'YouTube URL Input',
        'parameters': {
            'path': '/youtube2post',
            'method': 'POST',
            'responseMode': 'responseNode',
            'options': {
                'responseContentType': 'application/json'
            }
        }
    })

    # 2. éªŒè¯è¾“å…¥
    validate_input = builder.create_node('code', {
        'name': 'Validate Input',
        'parameters': {
            'jsCode': """
// éªŒè¯è¾“å…¥æ•°æ®
const items = $input.all();
const errors = [];

items.forEach(item => {
    const data = item.json;

    // æ£€æŸ¥å¿…éœ€å­—æ®µ
    if (!data.url) {
        errors.push('URL is required');
    } else if (!data.url.includes('youtube.com') && !data.url.includes('youtu.be')) {
        errors.push('Invalid YouTube URL');
    }

    // è®¾ç½®é»˜è®¤å€¼
    item.json = {
        ...data,
        language: data.language || 'en',
        quality: data.quality || 'high',
        screenshots: data.screenshots !== false,
        timestamp: new Date().toISOString()
    };
});

if (errors.length > 0) {
    throw new Error(errors.join(', '));
}

return items;
"""
        }
    })

    # 3. æå–è§†é¢‘ID
    extract_video_id = builder.create_node('code', {
        'name': 'Extract Video ID',
        'parameters': {
            'jsCode': """
// ä»URLæå–è§†é¢‘ID
const items = $input.all();

return items.map(item => {
    const url = item.json.url;
    let videoId = '';

    // å¤„ç†ä¸åŒæ ¼å¼çš„YouTube URL
    if (url.includes('youtube.com/watch?v=')) {
        videoId = url.split('v=')[1].split('&')[0];
    } else if (url.includes('youtu.be/')) {
        videoId = url.split('youtu.be/')[1].split('?')[0];
    }

    return {
        json: {
            ...item.json,
            videoId: videoId,
            downloadUrl: `https://www.youtube.com/watch?v=${videoId}`
        }
    };
});
"""
        }
    })

    # 4. ä¸‹è½½è§†é¢‘ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
    download_info = builder.create_node('http', {
        'name': 'Get Video Info',
        'parameters': {
            'method': 'GET',
            'url': '=https://www.youtube.com/oembed?url={{$json.downloadUrl}}&format=json',
            'options': {
                'timeout': 10000
            }
        }
    })

    # 5. å¤„ç†è§†é¢‘ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºä»£ç èŠ‚ç‚¹ï¼‰
    process_video = builder.create_node('code', {
        'name': 'Process Video',
        'parameters': {
            'jsCode': """
// æ¨¡æ‹Ÿè§†é¢‘å¤„ç†
const items = $input.all();

return items.map(item => {
    const videoInfo = item.json;

    // æ¨¡æ‹Ÿæå–çš„æ•°æ®
    const processedData = {
        ...videoInfo,
        title: videoInfo.title || 'Untitled Video',
        author: videoInfo.author_name || 'Unknown',
        duration: Math.floor(Math.random() * 600) + 60, // æ¨¡æ‹Ÿæ—¶é•¿
        quotes: [
            {
                text: "This is an important quote from the video",
                timestamp: "00:01:23",
                confidence: 0.95
            },
            {
                text: "Another meaningful statement",
                timestamp: "00:03:45",
                confidence: 0.88
            }
        ],
        summary: "This is an AI-generated summary of the video content.",
        tags: ["education", "technology", "tutorial"],
        processedAt: new Date().toISOString()
    };

    return {
        json: processedData
    };
});
"""
        }
    })

    # 6. ç”Ÿæˆæ–‡ç« 
    generate_article = builder.create_node('code', {
        'name': 'Generate Article',
        'parameters': {
            'jsCode': """
// ç”ŸæˆMarkdownæ–‡ç« 
const items = $input.all();

return items.map(item => {
    const data = item.json;

    // ç”ŸæˆMarkdownæ ¼å¼çš„æ–‡ç« 
    const article = `# ${data.title}

**Author**: ${data.author}
**Duration**: ${Math.floor(data.duration / 60)}:${(data.duration % 60).toString().padStart(2, '0')}
**Processed**: ${data.processedAt}

## Summary

${data.summary}

## Key Quotes

${data.quotes.map(q => `> "${q.text}" - [${q.timestamp}]`).join('\\n\\n')}

## Tags

${data.tags.map(tag => `#${tag}`).join(' ')}

---

*Generated by YouTube2Post Workflow*
`;

    return {
        json: {
            ...data,
            article: article,
            wordCount: article.split(' ').length,
            success: true
        }
    };
});
"""
        }
    })

    # 7. å‡†å¤‡å“åº”
    prepare_response = builder.create_node('code', {
        'name': 'Prepare Response',
        'parameters': {
            'jsCode': """
// å‡†å¤‡æœ€ç»ˆå“åº”
const items = $input.all();
const data = items[0].json;

return [{
    json: {
        success: true,
        message: "Video processed successfully",
        data: {
            videoId: data.videoId,
            title: data.title,
            wordCount: data.wordCount,
            quotesCount: data.quotes.length,
            article: data.article
        },
        timestamp: new Date().toISOString()
    }
}];
"""
        }
    })

    # 8. å‘é€å“åº”
    respond = builder.create_node('respond', {
        'name': 'Send Response',
        'parameters': {
            'respondWith': 'json',
            'responseBody': '={{$json}}',
            'options': {
                'responseCode': 200
            }
        }
    })

    # 9. é”™è¯¯å¤„ç†
    error_handler = builder.create_node('respond', {
        'name': 'Error Response',
        'position': [850, 500],
        'parameters': {
            'respondWith': 'json',
            'responseBody': '={{ {"success": false, "error": "Processing failed", "timestamp": new Date().toISOString()} }}',
            'options': {
                'responseCode': 500
            }
        }
    })

    # è¿æ¥èŠ‚ç‚¹
    print("ğŸ”— Connecting nodes...")
    builder.chain_nodes([
        webhook['id'],
        validate_input['id'],
        extract_video_id['id'],
        download_info['id'],
        process_video['id'],
        generate_article['id'],
        prepare_response['id'],
        respond['id']
    ])

    # æ„å»ºå·¥ä½œæµ
    workflow = builder.build_workflow(
        name="YouTube2Post Workflow",
        description="Convert YouTube videos to articles with AI"
    )

    print("âœ… Workflow created successfully!")
    return workflow


def deploy_workflow(workflow):
    """éƒ¨ç½²å·¥ä½œæµåˆ°n8n"""

    print("\nğŸ“¤ Deploying workflow to n8n...")

    # åˆå§‹åŒ–ç®¡ç†å™¨
    manager = N8nWorkflowManager()

    # æµ‹è¯•è¿æ¥
    if not manager.test_connection():
        print("âŒ Failed to connect to n8n. Please check your configuration.")
        return None

    # åˆ›å»ºå·¥ä½œæµ
    result = manager.create_workflow(workflow)

    if 'error' in result:
        print(f"âŒ Failed to create workflow: {result['error']}")
        return None

    workflow_id = result.get('id')
    print(f"âœ… Workflow created with ID: {workflow_id}")

    # æ¿€æ´»å·¥ä½œæµ
    if manager.deploy_workflow(workflow_id):
        print(f"âœ… Workflow activated successfully!")
        print(f"ğŸŒ Webhook URL: {manager.base_url}/webhook/youtube2post")
        return workflow_id
    else:
        print("âŒ Failed to activate workflow")
        return None


def test_workflow(workflow_id=None):
    """æµ‹è¯•å·¥ä½œæµ"""

    print("\nğŸ§ª Testing workflow...")

    import requests

    # æµ‹è¯•æ•°æ®
    test_data = {
        "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
        "language": "en",
        "quality": "high"
    }

    # å‘é€æµ‹è¯•è¯·æ±‚
    try:
        response = requests.post(
            "http://localhost:5678/webhook/youtube2post",
            json=test_data,
            timeout=30
        )

        if response.status_code == 200:
            print("âœ… Test successful!")
            print("Response:", json.dumps(response.json(), indent=2))
        else:
            print(f"âŒ Test failed with status code: {response.status_code}")
            print("Response:", response.text)
    except Exception as e:
        print(f"âŒ Test failed: {e}")


def main():
    """ä¸»å‡½æ•°"""

    print("=" * 60)
    print("YouTube2Post Workflow Creator")
    print("=" * 60)

    # åˆ›å»ºå·¥ä½œæµ
    workflow = create_youtube2post_workflow()

    # ä¿å­˜åˆ°æ–‡ä»¶
    output_file = "youtube2post_workflow.json"
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(workflow, f, indent=2, ensure_ascii=False)
    print(f"\nğŸ’¾ Workflow saved to: {output_file}")

    # è¯¢é—®æ˜¯å¦éƒ¨ç½²
    deploy = input("\nğŸš€ Deploy workflow to n8n? (y/n): ")
    if deploy.lower() == 'y':
        workflow_id = deploy_workflow(workflow)

        if workflow_id:
            # è¯¢é—®æ˜¯å¦æµ‹è¯•
            test = input("\nğŸ§ª Test the workflow? (y/n): ")
            if test.lower() == 'y':
                test_workflow(workflow_id)

    print("\nâœ¨ Done!")


if __name__ == "__main__":
    main()